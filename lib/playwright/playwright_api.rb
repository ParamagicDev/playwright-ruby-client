module Playwright
  class PlaywrightApi
    # Wrap ChannelOwner.
    # Playwright::ChannelOwners::XXXXX will be wrapped as Playwright::XXXXX
    # Playwright::XXXXX is automatically generated by development/generate_api
    #
    # @param channel_owner [ChannelOwner]
    # @note Intended for internal use only.
    def self.from_channel_owner(channel_owner)
      Factory.new(channel_owner, 'ChannelOwners').create
    end

    class Factory
      def initialize(impl, module_name)
        impl_class_name = impl.class.name
        unless impl_class_name.include?("::#{module_name}::")
          raise "#{impl_class_name} is not #{module_name}"
        end

        @impl = impl
        @module_name = module_name
      end

      def create
        api_class = detect_class_for(@impl.class)
        if api_class
          api_class.new(@impl)
        else
          raise NotImplementedError.new("Playwright::#{expected_class_name_for(@impl.class)} is not implemented")
        end
      end

      private

      def expected_class_name_for(klass)
        klass.name.split("::#{@module_name}::").last
      end

      def superclass_exist?(klass)
        ![::Playwright::ChannelOwner, ::Playwright::InputType, Object].include?(klass.superclass)
      end

      def detect_class_for(klass)
        class_name = expected_class_name_for(klass)
        if ::Playwright.const_defined?(class_name)
          ::Playwright.const_get(class_name)
        elsif superclass_exist?(klass)
          detect_class_for(klass.superclass)
        else
          nil
        end
      end
    end

    # @param impl [Playwright::ChannelOwner|Playwright::InputType]
    def initialize(impl)
      @impl = impl
    end

    def ==(other)
      @impl.to_s == other.instance_variable_get(:'@impl').to_s
    end

    # @param block [Proc]
    private def wrap_block_call(block)
      return nil unless block.is_a?(Proc)

      -> (*args) {
        wrapped_args = args.map { |arg| wrap_impl(arg) }
        block.call(*wrapped_args)
      }
    end

    private def wrap_impl(object)
      case object
      when ChannelOwner
        PlaywrightApi.from_channel_owner(object)
      when InputType
        Factory.new(object, 'InputTypes').create
      when Array
        object.map { |obj| wrap_impl(obj) }
      else
        object
      end
    end
  end
end
